version: "3.8"
services:
    mongodb:
        image: mongo
        container_name: mongodb
        environment:
            - PUID=1000
            - PGID=1000
        ports:
            - "27016:27017"
        volumes:
            - db:/data/db
        restart: unless-stopped
        networks:
            - net_lemverse
    lemverse:
        image: riderx/lemverse
        container_name: lemverse
        restart: unless-stopped
        networks:
            - net_lemverse
        depends_on:
            - mongodb
            - peer
        volumes:
            - lemverse:/var/tmp/lemverse
        environment:
            ROOT_URL: ${APP_ROOT_URL:-http://localhost}
            MONGO_URL: mongodb://mongodb:27017/meteor
            PORT: 3000
            METEOR_SETTINGS: |
                {
                    "public": {
                        "title": "INDIE VERSE",
                        "lp": {
                            "product": "lemverse",
                            "process": "main",
                            "gods": ["usr_CYAGPigRTMExDMT8F"],
                            "production": false,
                            "staging": false,
                            "enableLogClient": false
                        },

                        "debug": false,

                        "defaultReaction": "❤️",

                        "zoom": 1,

                        "peer": {
                            "answerMaxAttempt": 5,
                            "answerDelayBetweenAttempt": 750,
                            "avatars": [
                                "https://www.monchat.ca/wp-content/uploads/2020/01/Fond-ecran-mignon-chaton-en-position-de-priere-1024x640.jpg",
                                "https://animalaxy.fr/wp-content/uploads/2019/02/iStock5.jpg",
                                "https://cdn.radiofrance.fr/s3/cruiser-production/2018/12/9f19b228-269f-4995-ba7f-eda054945811/1136_gettyimages-155607257.jpg",
                                "https://chatfaitdubien.fr/wp-content/uploads/2016/09/chaton.jpg",
                                "https://i.pinimg.com/564x/8b/f7/c6/8bf7c6e26f7250944e963f23f364b68f.jpg"
                            ],
                            "callDelay": 250
                        },

                        "meet": {
                            "serverURL": "jitsi.indiemakers.space",
                            "roomDefaultName": "lemverse-test"
                        },

                        "character": {
                            "walkSpeed": 180,
                            "runSpeed": 720
                        },

                        "characterNames": ["Basic", "Ghost"],

                        "skins": {
                            "guest": "CFw26kjH8ADLY6omW",
                            "default": "Basic"
                        },

                        "templateLevelId": "lvl_iLOVEaLOTlemverse"
                    },

                    "defaultLevelId": "lvl_iLOVEaLOTlemverse",

                    "peer": {
                        "startServer": false,
                        "server": {
                        "url": "peer.indiemakers.space",
                        "port": 443,
                        "path": "/myapp",
                        "credentialDuration": 86400,
                        "secret": "",
                        "config": {
                            "iceServers": [{ 
                            "urls": "stun:stun.l.google.com:19302"
                            }],
                            "sdpSemantics": "unified-plan"
                        }
                        }
                    }
                }

    peer:
        image: peerjs/peerjs-server
        container_name: peer
        restart: unless-stopped
        networks:
            - net_lemverse
    caddy:
        image: caddy/caddy:alpine
        container_name: caddy
        environment:
            FRONTEND_HOST: app.indiemakers.space
            JITSI_HOST: video.indiemakers.space
            FRONTEND_SERVICE: lemverse
            PEER_HOST: peer.indiemakers.space
            PEER_SERVICE: peer
        ports:
            - "80:80"
            - "443:443"
        networks:
            - net_lemverse
        volumes:
            - ./Caddyfile:/etc/caddy/Caddyfile:ro
            - caddy:/data/caddy:z

volumes:
    lemverse:
        driver: local 
    caddy:
        driver: local
    db:
        driver: local
    
# Custom network so all services can communicate using a FQDN
networks:
    net_lemverse:
        driver: bridge
        name: net_lemverse